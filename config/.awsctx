# Strip leading white space (new line inclusive).
function _ltrim(){
    [[ "$1" =~ [^[:space:]].* ]]
    printf "%s" "$BASH_REMATCH"
}

# Strip trailing white space (new line inclusive).
function _rtrim(){
    [[ "$1" =~ .*[^[:space:]] ]]
    printf "%s" "$BASH_REMATCH"
}

# Strip leading and trailing white space (new line inclusive).
function _trim(){
    printf "%s" "$(_rtrim "$(_ltrim "$1")")"
}

function _awsListAll() {
    credentialFileLocation=${AWS_SHARED_CREDENTIALS_FILE};
    if [ -z $credentialFileLocation ]; then
        credentialFileLocation=~/.aws/credentials
    fi
 
    while read line; do
        line=$(_trim "$line")
        if [[ $line == "["* ]]; then echo ${line:1:$((${#line}-2))}; fi;
    done < $credentialFileLocation;
};
 
function _awsSwitchProfile() {
   if [ -z $1 ]; then aws configure list; return; fi
   
   exists="$(aws configure get aws_access_key_id --profile $1)"
   if [[ -n $exists ]]; then
       export AWS_DEFAULT_PROFILE=$1;
       export AWS_PROFILE=$1;
       export AWS_REGION=$(aws configure get region --profile $1);
       echo "Switched to AWS Profile: $1";
       aws configure list
   fi
};

alias awsall="_awsListAll"
alias awsctx="_awsSwitchProfile"

_aws_contexts()
{
  local curr_arg;
  curr_arg=${COMP_WORDS[COMP_CWORD]}
  COMPREPLY=( $(compgen -W "- $(awsall)" -- $curr_arg ) );
}

complete -F _aws_contexts awsctx